<nz-breadcrumb style="margin:16px 0;">
  <nz-breadcrumb-item>Trang chủ</nz-breadcrumb-item>
  <nz-breadcrumb-item>Nghiệp vụ</nz-breadcrumb-item>
  <nz-breadcrumb-item>Kho</nz-breadcrumb-item>
  <nz-breadcrumb-item>Sửa phiếu thanh lý</nz-breadcrumb-item>
</nz-breadcrumb>

<div style="padding:24px; background: #fff; min-height: 70vh">

  <nz-card style="width:100%;" nzTitle="Thanh lý vật tư">
    <form nz-form [formGroup]="liquidationMaterialForm" (ngSubmit)="saveChanges()" autocomplete="off">
      <table style="width: 100%;">
        <tr>
          <td style="width: 35%">
            <nz-form-item>
              <nz-form-label [nzSm]="8" [nzXs]="24" nzRequired nzFor="maKho">Kho hàng</nz-form-label>
              <nz-form-control [nzSm]="16" [nzXs]="24">
                <nz-select nzShowSearch nzAllowClear nzPlaceHolder="Chọn kho hàng" formControlName="maKho" id="maKho">
                  <nz-option *ngFor="let item of materialStores" [nzValue]="item.maKho" [nzLabel]="item.tenKho">
                  </nz-option>
                </nz-select>
                <nz-form-explain
                  *ngIf="liquidationMaterialForm.get('maKho').dirty && liquidationMaterialForm.get('maKho').errors">
                  <ng-container *ngIf="liquidationMaterialForm.get('maKho').hasError('required')">
                    Vui lòng chọn kho hàng!
                  </ng-container>
                </nz-form-explain>
              </nz-form-control>
            </nz-form-item>
          </td>
          <td style="width: 35%">
            <nz-form-item>
              <nz-form-label [nzSm]="8" [nzXs]="24" nzRequired nzFor="maNS">Nhân sự</nz-form-label>
              <nz-form-control [nzSm]="16" [nzXs]="24">
                <nz-select nzShowSearch nzAllowClear nzPlaceHolder="Chọn nhân sự" formControlName="maNS" id="maNS">
                  <nz-option *ngFor="let item of personnels" [nzValue]="item.maNS" [nzLabel]="item.hoTen"></nz-option>
                </nz-select>
                <nz-form-explain
                  *ngIf="liquidationMaterialForm.get('maNS').dirty && liquidationMaterialForm.get('maNS').errors">
                  <ng-container *ngIf="liquidationMaterialForm.get('maNS').hasError('required')">
                    Vui lòng chọn nhân sự!
                  </ng-container>
                </nz-form-explain>
              </nz-form-control>
            </nz-form-item>
          </td>
          <td style="width: 30%">
            <nz-form-item>
              <nz-form-label [nzSm]="10" [nzXs]="24" nzRequired nzFor="ngayThanhLy">Ngày thanh lý</nz-form-label>
              <nz-form-control [nzSm]="14" [nzXs]="24">
                <input type="date" nz-input formControlName="ngayThanhLy" id="ngayThanhLy" />
                <nz-form-explain
                  *ngIf="liquidationMaterialForm.get('ngayThanhLy').dirty && liquidationMaterialForm.get('ngayThanhLy').errors">
                  <ng-container *ngIf="liquidationMaterialForm.get('ngayThanhLy').hasError('required')">
                    Vui lòng chọn ngày thanh lý!
                  </ng-container>
                </nz-form-explain>
              </nz-form-control>
            </nz-form-item>
          </td>
        </tr>
        <tr>
          <td colspan="3" style="text-align: right;">
            <button type="button" nz-button nzType="default" [routerLink]="['/admin/nghiep-vu/thanh-ly-vat-tu']">
              <i nz-icon type="close" theme="outline"></i> Hủy
            </button>
            <button type="submit" nz-button nzType="primary" style="margin-left:1rem;"
              [disabled]="!liquidationMaterialForm.dirty">
              <i nz-icon type="save" theme="outline"></i> Lưu
            </button>
          </td>
        </tr>
      </table>
    </form>
  </nz-card>
  <br />
  <nz-card style="width:100%;" nzTitle="Danh sách tồn kho" *ngIf="inventories.length > 0">
    <div nz-row style="margin-bottom: 0.5rem">
      <div nz-col nzSpan="8">
        <nz-input-group nzSearch [nzSuffix]="suffixIconButton">
          <input type="text" nz-input placeholder="Tìm kiếm..." #keywordInventory
            (keyup.enter)="searchInventory(keywordInventory.value)">
        </nz-input-group>
        <ng-template #suffixIconButton>
          <button nz-button nzType="primary" nzSearch (click)="searchInventory(keywordInventory.value)"><i nz-icon
              type="search"></i></button>
        </ng-template>
      </div>
      <div nz-col nzSpan="8" nzOffset="8" class="text-right">
      </div>
    </div>
    <nz-table #inventoryTable [nzData]="inventories" nzBordered [nzLoading]="loadingInventories"
      [nzShowPagination]="false" nzSize="middle">
      <thead>
        <tr>
          <th nzWidth="40%">Vật tư</th>
          <th nzWidth="30%">Mã phiếu nhập</th>
          <th nzWidth="20%">Số lượng tồn</th>
          <th nzWidth="10%"></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let data of inventoryTable.data">
          <td>{{data.tenVatTu}}</td>
          <td class="text-center">{{data.maPhieuNhap}}</td>
          <td class="text-center">{{data.soLuongTon}}</td>
          <td class="text-center">
            <button nz-button nzType="primary" nzSize="small" nz-tooltip nzTitle="Tạo"
              (click)="createLiquidationDetail(data)" *ngIf="data.soLuongTon > 0">
              <i nz-icon type="caret-down" theme="outline"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </nz-table>
  </nz-card>
  <br />
  <nz-card style="width:100%;" nzTitle="Danh sách thanh lý vật tư" *ngIf="liquidationDetails.length > 0">
    <nz-table #liquidationDetailTable [nzData]="liquidationDetails" nzBordered [nzLoading]="loadingLiquidationDetails"
      [nzShowPagination]="false" nzSize="middle">
      <thead>
        <tr>
          <th nzWidth="10%"></th>
          <th nzWidth="15%">Mã phiếu TL</th>
          <th nzWidth="15%">Mã phiếu nhập</th>
          <th nzWidth="20%">Tên vật tư</th>
          <th nzWidth="10%">ĐVT</th>
          <th nzWidth="10%">Ghi chú</th>
          <th nzWidth="10%">Diễn giải</th>
          <th nzWidth="10%">Số lượng TL</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let data of liquidationDetailTable.data">
          <td class="text-center">
            <nz-button-group>
              <button nz-button nzType="default" class="btn-info" nz-tooltip nzTitle="Sửa"
                (click)="updateLiquidationDetail(data)">
                <i nz-icon type="edit" theme="outline"></i>
              </button>
              <button nz-button nzType="default" class="btn-danger" nz-tooltip nzTitle="Xóa"
                (click)="deleteLiquidationDetail(data)">
                <i nz-icon type="delete" theme="outline"></i>
              </button>
            </nz-button-group>
          </td>
          <td class="text-center">{{data.maPhieuThanhLy}}</td>
          <td class="text-center">{{data.maPhieuNhap}}</td>
          <td class="text-center">{{data.tenVT}}</td>
          <td class="text-center">{{data.tenDVT}}</td>
          <td class="text-center">{{data.ghiChu}}</td>
          <td class="text-center">{{data.dienGiai}}</td>
          <td class="text-center">{{data.soLuongThanhLy}}</td>
        </tr>
        <tr class="bg-footer-price">
          <td colspan="7" class="text-right">
            <strong>Tổng cộng:</strong>
          </td>
          <td class="text-center">
            <strong>{{totalQuantity | number: '1.0-0'}}</strong>
          </td>
        </tr>
      </tbody>
    </nz-table>
  </nz-card>
</div>